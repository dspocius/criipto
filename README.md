# NodeJS express v.12.x

This tutorial demonstrates how to add user login to your NodeJS express application. 

We assume that you already done two steps in Criipto side:
1. Register your application in Criipto Verify [a link](https://docs.criipto.com/authentication/aspnetcore/#register)
2. Configure your OAuth2 flow [a link](https://docs.criipto.com/authentication/aspnetcore/#flow)

## Quick Start

1. Just clone or download ZIP file (and extract it to projects folder) of this github.
2. Go to projects directory with terminal.
3. Run: npm install
4. Run: npm start or node bin/www

## Preparation
Four steps are required to complete your first test login:
1. Generate express project [a link](https://expressjs.com/en/starter/generator.html) (Optional)
2. Install npm dependencies
3. Add your configuration info
4. Add "Criipto" routes and views

## Dependencies
### Libraries and versions we used:
```javascript
  "dependencies": {
    "cookie-parser": "~1.4.4",
    "debug": "~2.6.9",
    "express": "~4.16.1",
    "express-openid-connect": "^0.5.0",
    "express-session": "^1.17.0",
    "http-errors": "~1.6.3",
    "jade": "~1.11.0",
    "morgan": "~1.9.1"
  }
```
Two: **express-openid-connect** and **express-session** we added manually - others were generated by node express generator.

### So, you can just install these two dependencies to your existing project:
```
npm i express-openid-connect --save
npm i express-session --save
```
## Configuration file

You can use .env file - it is good approach, but this time for convenient we used config.js file (create folder config and add config.js):

```javascript
var config = {
	Domain: "Criipto:Domain", // Domain from application registration
	clientID: "Criipto:ClientId", // ClientID from application registration
	ClientSecret: "Criipto:ClientSecret", // ClientSecret from application registration
	BaseUrl: "https://localhost:5001" // Your projects url and port
};

module.exports = config;
```

Change configuration according to yours.

## Create Criipto Routes and Views
### Setting up main file and view

Add this to top of your file - to load dependent libraries.

```javascript
// ------ Criipto routes and libs required for openID connection
var criiptoConfig = require('./config/config');
var criiptoLogin = require('./routes/CriiptoLogin');
var criiptoConnected = require('./routes/CriiptoConnected');
var session = require('express-session');
const { auth, requiresAuth, requiresCheckAuth } = require('express-openid-connect');

// -------------------------------------------------------------
```

Later we will create **./routes/CriiptoLogin** and **./routes/CriiptoConnected** files for handling connection/signing out and showing returned data if you sign in.

Add following code somewhere after **var app = express();**.

```javascript
/*  ---------------------------------------------------  */
var sessionData = {
	resave: true,
	saveUninitialized: true,
	secret: criiptoConfig.ClientSecret, 
	cookie: { maxAge: 90*24*60*60*1000 } //90 days
};

if (app.get('env') === 'production') {
  app.set('trust proxy', 1) // trust first proxy
  sessionData.cookie.secure = true // serve secure cookies
}

app.use(session(sessionData));

//Every route after the auth() middleware gets authentication info or requires authentication if required is set to true
app.use(auth({
  authorizationParams: {
  	response_type: "code"
  },
  // The next to settings must match the Callback URLs in Criipto Verify
  redirectUriPath: "/callback",
  logoutPath: "/signout",
  routes: false,
  required: false,
  issuerBaseURL: criiptoConfig.Domain,
  baseURL: criiptoConfig.BaseUrl,
  clientID: criiptoConfig.clientID,
  clientSecret: criiptoConfig.ClientSecret // need for response_type: "code"
}));

app.use('/', indexRouter);
app.use('/criipto', criiptoLogin);
app.use('/callback', requiresAuth(), criiptoConnected); // requiresAuth() protects this view from unauthorized access

/*  ---------------------------------------------------  */
```

Change your routes/index.js - Main route that you see when you open application.

```javascript
var express = require('express');
var router = express.Router();

router.get('/', function(req, res, next) {
  var userNotLogged = !req.openid || !req.openid.user;	
  
	if (!userNotLogged) {
	  var userdata = req.openid.user;
	  res.render('CriiptoConnected', { title: 'User logged in', userdata: userdata, userLogged: true  });
	}else{
	  res.render('CriiptoLogin', { title: 'Login', userLogged: !userNotLogged });
	}
});

module.exports = router;
```
Here we check if user is logged in or not - according to that we render a relevant view for user.

Now we added main routes and created authentication object with our configured data. What we need is the actual code that shows form to user (which bank we want to use and what to show when connected).


### Create a Connection View and Logic
#### Create a file "CriiptoLogin.jade" in views

```javascript
extends layout
block content
  div(class="text-center")
    h1 Criipto Verify log in tester
    p Choose your login. Test users you get 
      a(href="http://docs.criipto.com/how-to/test-users.md") from here.
    form(name="criiptoForm", method="post", action="/criipto/login")
      div
        select(name="loginmethod")
          option(value="urn:grn:authn:no:bankid:mobile") Norwegian BankID Mobile
          option(value="urn:grn:authn:no:bankid:central") Norwegian Hardware token (kodebrikke)
          option(value="urn:grn:authn:se:bankid:same-device") Swedish BankID same device
          option(value="urn:grn:authn:se:bankid:another-device") Swedish BankID another device
          option(value="urn:grn:authn:dk:nemid:poces") Danish NemID personal with code card
          option(value="urn:grn:authn:dk:nemid:moces") Danish NemID employee with code card
          option(value="urn:grn:authn:dk:nemid:moces:codefile") Danish NemID employee with code file
          option(value="urn:grn:authn:fi:tupas") Finnish BankID
          option(value="urn:grn:authn:fi:mobile-id") Finnish Mobile Certificate
          option(value="urn:grn:authn:fi:all") Choose from all Finnish options
      br
      div.actions
       input(type="submit", value="Login")
```

We used default "Jade" view engine to create a form. You must set **AcrValues** parameter (select element) on the authentication request in order to choose the type of authentication you want. This form sends post request to: **/criipto/login**. Now we will create backend file that shows this form to us and will login us.

#### Create a file "CriiptoLogin.js" in routes

```javascript
var express = require('express');
var router = express.Router();

router.get('/signout', (req, res) => {
	res.openid.logout()
});

router.post('/login', (req, res) => {
	if (req.body == null || req.body.loginmethod == null) {
		const userLogged = !req.openid || !req.openid.user;
		
		res.render('CriiptoLogin', { title: 'Login', userLogged: userLogged });
	}else{
		res.openid.login({ authorizationParams: {acr_values: req.body.loginmethod }});
	}
});


module.exports = router;
```
When user calls a post function - we first look if user sends right data to us. If data is there then we set **acr_values** parameter which is a must and send it to Criipto for logging. **If you want to read more about possible acr_values and logging - [a link](https://docs.criipto.com/authentication/aspnetcore/#application)**

At this point you may login but you will not see your data. Lets now add connected view.

### Create a view and logic when you successfully connect
#### Create a file "CriiptoConnected.jade" in views

```javascript
extends layout

block content
  h1 Welcome
  each val, index in userdata
    dt= index
    dd= val
```

We just show connected user data (it is Object type - we show key and value)

#### Create a file "CriiptoConnected.js" in routes
```javascript
var express = require('express');
var router = express.Router();

router.get('/', function(req, res, next) {
  var userdata = req.openid.user;
  
  res.render('CriiptoConnected', { title: 'User Logged In', userdata: userdata, userLogged: true  });
});

module.exports = router;
```
Here we do not need to check if user is logged in because express-open-id library does that for us (requiresAuth() in main file next to this route). We just send data to view to show logged user data.

#### So, Now you can login and view your data
#### Signing out

Just add a link with check somewhere in your view file (we added in Layout - top menu):
```javascript
if userLogged
  a(class="nav-link text-dark" href="/criipto/signout") Logout
```

### Furthermore

We also implemented small menu and cookies consent. That is why we added **userLogged** variable when rendered views. It is used for user to show Logout menu. You can check code by cloning it or downloading ZIP.
